<!-- templates/index.html - 拡張機能版 -->
<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Social Guillotine - 怠惰な大学生是正アプリ</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>

    <div class="container">
        <!-- ヘッダー -->
        <header>
            <h1 class="app-title">☠️ Social Guillotine</h1>
            <p class="subtitle">怠惰な大学生は、社会的処刑に値する</p>
            
            <!-- タブナビゲーション -->
            <div class="tabs">
                <button class="tab-btn active" onclick="switchTab('tasks')">📋 タスク</button>
                <button class="tab-btn" onclick="switchTab('ranking')">🏆 ランキング</button>
                <button class="tab-btn" onclick="switchTab('group')">👥 グループ</button>
                <button class="tab-btn" onclick="switchTab('badges')">🎖️ バッジ</button>
            </div>

            <!-- 統計パネル -->
            <div class="stats-panel">
                <div class="stat-item">
                    <span class="stat-label">📊 怠惰度</span>
                    <span class="stat-value" id="lazynessScore">0.0%</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">✅ 完了</span>
                    <span class="stat-value" id="completedCount">0</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">⚡ 連続</span>
                    <span class="stat-value" id="streakCount">0日</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">💀 処刑</span>
                    <span class="stat-value" id="punishedCount">0</span>
                </div>
            </div>

            <button id="openModalBtn" class="add-btn">⚠️ 処刑契約書を作成</button>
        </header>

        <!-- メインコンテンツ -->
        <main>
            <!-- タスクタブ -->
            <div id="tasks-tab" class="tab-content active">
                <ul class="task-list" id="taskList">
                    <!-- JavaScriptで動的に生成 -->
                </ul>
            </div>

            <!-- ランキングタブ -->
            <div id="ranking-tab" class="tab-content">
                <div class="ranking-section">
                    <h2>🏆 全体ランキング</h2>
                    <table class="ranking-table" id="globalRanking">
                        <thead>
                            <tr>
                                <th>順位</th>
                                <th>ユーザー</th>
                                <th>怠惰度</th>
                                <th>完了</th>
                                <th>処刑</th>
                            </tr>
                        </thead>
                        <tbody id="rankingBody">
                            <!-- JavaScriptで生成 -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- グループタブ -->
            <div id="group-tab" class="tab-content">
                <div class="group-section">
                    <h2>👥 グループ管理</h2>
                    
                    <div class="group-actions">
                        <button onclick="showGroupCreateForm()" class="btn-primary">新しいグループを作成</button>
                        <button onclick="showGroupJoinForm()" class="btn-primary">グループに参加</button>
                    </div>

                    <!-- グループ作成フォーム -->
                    <form id="groupCreateForm" method="post" action="/group/create" style="display:none; margin-top: 20px; padding: 20px; background: #333; border-radius: 8px;">
                        <h3>グループを作成</h3>
                        <input type="text" name="group_name" placeholder="グループ名" required maxlength="100">
                        <button type="submit" class="btn-primary">作成</button>
                        <button type="button" onclick="this.parentElement.style.display='none'" class="btn-secondary">キャンセル</button>
                    </form>

                    <!-- グループ参加フォーム -->
                    <form id="groupJoinForm" method="post" action="/group/join" style="display:none; margin-top: 20px; padding: 20px; background: #333; border-radius: 8px;">
                        <h3>グループに参加</h3>
                        <input type="text" name="invite_code" placeholder="招待コード (例: ABC123)" required maxlength="10">
                        <button type="submit" class="btn-primary">参加</button>
                        <button type="button" onclick="this.parentElement.style.display='none'" class="btn-secondary">キャンセル</button>
                    </form>
                </div>
            </div>

            <!-- バッジタブ -->
            <div id="badges-tab" class="tab-content">
                <div class="badges-section">
                    <h2>🎖️ 獲得バッジ</h2>
                    <div class="badges-grid" id="badgesGrid">
                        <!-- JavaScriptで生成 -->
                    </div>
                    
                    <h3 style="margin-top: 30px;">バッジ一覧</h3>
                    <ul class="badge-list">
                        <li>🔥 <strong>7日連続達成者</strong> - 7日連続でタスクを完了</li>
                        <li>✨ <strong>10個完了達成者</strong> - 10個のタスクを完了</li>
                        <li>👑 <strong>完璧主義者</strong> - 5個以上のタスクを処刑ゼロで完了</li>
                    </ul>
                </div>
            </div>
        </main>
    </div>

    <!-- タスク追加モーダル -->
    <div id="addTaskModal" class="modal">
        <div class="modal-content input-mode">
            <span class="close-btn" onclick="closeModal('addTaskModal')">&times;</span>
            <h2>💀 処刑契約書の作成</h2>
            <form action="{{ url_for('add_task') }}" method="post">
                <label>義務（Task content）</label>
                <input type="text" name="task_title" placeholder="例：明日の1限に出席する" maxlength="200" required>

                <label>期限（Time Limit）</label>
                <input type="datetime-local" name="deadline" required>

                <label style="color: #e74c3c; font-weight: bold;">遅れた時の投稿内容（自動投稿）</label>
                <textarea name="penalty_text" placeholder="例：今日も一限に起きられませんでした。明日山田にご飯を奢ります。" maxlength="500" required></textarea>

                <button type="submit" class="danger-btn">タスクに追加</button>
            </form>
        </div>
    </div>

    <!-- 偽ツイートモーダル -->
    <div id="fakeTweetModal" class="modal tweet-modal">
        <div class="modal-content tweet-content">
            <span class="close-btn" onclick="closeTweetModal()">&times;</span>
            <h3 style="color: #1da1f2;">🔔 Discord自動投稿通知</h3>
            <p>以下の内容があなたのアカウントから投稿されました。</p>
            
            <div class="fake-tweet-card">
                <div class="tweet-header">
                    <div class="tweet-icon"></div>
                    <div class="tweet-name">{{ user.display_name or 'あなた' }} <span style="color:gray">@lazy_student</span></div>
                </div>
                <div class="tweet-body" id="tweetTextDisplay"></div>
                <div class="tweet-footer">
                    <span>💬 12</span> <span>🔄 89</span> <span>❤️ 204</span>
                </div>
            </div>

            <p style="margin-top: 20px; color: red; font-weight: bold;">あー...次はちゃんとやろうね。</p>
            <button onclick="closeTweetModal()" class="close-tweet-btn">次は絶対に送れないという気持ちで閉じる</button>
        </div>
    </div>

    <!-- Flashメッセージ表示 -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div id="flashContainer" class="flash-container">
                {% for category, message in messages %}
                    <div class="flash-message flash-{{ category }}">
                        <span>{{ message }}</span>
                        <button class="flash-close" onclick="this.parentElement.remove()">&times;</button>
                    </div>
                {% endfor %}
            </div>
        {% endif %}
    {% endwith %}

    <!-- JavaScriptファイル読み込み -->
    <script src="{{ url_for('static', filename='script.js') }}"></script>
</body>
</html>